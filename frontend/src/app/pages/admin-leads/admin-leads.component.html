<div class="admin-leads">
  <header class="dashboard-nav">
    <div class="nav-container">
      <div class="nav-left">
        <div class="nav-brand">
          <span class="nav-title">Lead Exchange</span>
          <span class="nav-subtitle">Platform admin</span>
        </div>
        <nav class="nav-links">
          <a routerLink="/admin" class="nav-link">Dashboard</a>
          <a routerLink="/admin/leads" class="nav-link" routerLinkActive="active">Leads</a>
          <a routerLink="/admin/agencies" class="nav-link" routerLinkActive="active">Agencies</a>
          <a routerLink="/admin/agents" class="nav-link" routerLinkActive="active">Agents</a>
        </nav>
      </div>
      <div class="nav-right">
        <span class="nav-section-label">Admin</span>
      </div>
    </div>
  </header>

  <main class="dashboard-container">
    <section class="header-section">
      <div>
        <p class="eyebrow">Lead management</p>
        <h1 class="page-title">All seller leads</h1>
        <p class="page-subtitle">Review, update, and manage lead status across the platform.</p>
      </div>
      <button class="btn btn-outline" type="button" (click)="loadLeads()">Refresh</button>
    </section>

    <section class="filters-section">
      <div class="filter-field">
        <span>Search</span>
        <input
          type="text"
          placeholder="Search by name, email, phone, address"
          [(ngModel)]="searchTerm"
          (input)="onFilterChange()"
        />
      </div>
      <div class="filter-field">
        <span>Status</span>
        <select [(ngModel)]="statusFilter" (change)="onFilterChange()">
          <option value="all">All</option>
          <option value="New">New</option>
          <option value="Contacted">Follow-Up</option>
          <option value="Scheduled">Appointment</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
      <div class="filter-field">
        <span>Property type</span>
        <select [(ngModel)]="propertyTypeFilter" (change)="onFilterChange()">
          <option value="all">All</option>
          <option value="house">House</option>
          <option value="apartment">Apartment</option>
          <option value="unit">Unit</option>
          <option value="townhouse">Townhouse</option>
          <option value="land">Land</option>
          <option value="other">Other</option>
        </select>
      </div>
    </section>

    <section class="table-section">
      <div class="table-header-row">
        <h2>Lead pipeline</h2>
        <span>{{ filteredLeads.length }} records</span>
      </div>

      <div *ngIf="isLoading" class="state-message">Loading leads...</div>
      <div *ngIf="!isLoading && errorMessage" class="state-message error">{{ errorMessage }}</div>

      <div class="table-scroll" *ngIf="!isLoading && !errorMessage">
        <table class="leads-table">
          <thead>
            <tr>
              <th>Lead</th>
              <th>Address</th>
              <th>Status</th>
              <th>Agency</th>
              <th>Assigned</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let lead of filteredLeads">
              <td class="cell-name" data-label="Lead">
                <span class="lead-name">{{ lead.homeownerName }}</span>
                <span class="lead-email">{{ lead.homeownerEmail }}</span>
              </td>
              <td class="cell-address" data-label="Address">{{ lead.propertyAddress }}</td>
              <td data-label="Status">
                <span class="status-badge status-{{ lead.status?.toLowerCase() || 'new' }}">
                  {{ formatStatus(lead.status) }}
                </span>
              </td>
              <td data-label="Agency">{{ lead.preferredAgency || '-' }}</td>
              <td data-label="Assigned">{{ lead.assignedAgentName || '-' }}</td>
              <td class="cell-actions" data-label="Actions">
                <button class="btn-small btn-view" type="button" (click)="viewLead(lead)">View</button>
                <button class="btn-small btn-action" type="button" (click)="manageLead(lead)">Manage</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="state-message" *ngIf="!isLoading && !errorMessage && filteredLeads.length === 0">
        No leads match your filters.
      </div>
    </section>

    <div class="modal-overlay" *ngIf="selectedLead && isModalOpen" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div>
            <h2>{{ selectedLead.homeownerName }}</h2>
            <p>{{ selectedLead.propertyAddress }}</p>
          </div>
          <button class="close-btn" type="button" (click)="closeModal()">Ã—</button>
        </div>

        <div class="modal-body">
          <div class="detail-section">
            <h3 class="section-title">Contact information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Email</span>
                <span class="detail-value">{{ selectedLead.homeownerEmail }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Phone</span>
                <span class="detail-value">{{ selectedLead.homeownerPhone }}</span>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h3 class="section-title">Lead details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ selectedLead.status || 'New' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Property type</span>
                <span class="detail-value">{{ selectedLead.propertyType || '-' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Preferred agency</span>
                <span class="detail-value">{{ selectedLead.preferredAgency || '-' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Assigned agent</span>
                <span class="detail-value">{{ selectedLead.assignedAgentName || '-' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Best time to call</span>
                <span class="detail-value">{{ selectedLead.preferredContactTime || 'Anytime' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Next follow-up</span>
                <span class="detail-value">{{ selectedLead.nextFollowUpDate | date:'medium' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Follow-up notes</span>
                <span class="detail-value">{{ selectedLead.followUpNotes || '-' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Created</span>
                <span class="detail-value">{{ selectedLead.createdAt | date:'medium' }}</span>
              </div>
            </div>
          </div>

          <div class="detail-section notes-panel" *ngIf="isViewOnly && selectedLead.callHistory && selectedLead.callHistory.length">
            <h3 class="section-title">Notes and history</h3>
            <ul class="history-list">
              <li *ngFor="let call of selectedLead.callHistory" class="history-item">{{ call }}</li>
            </ul>
          </div>

          <div class="detail-section" *ngIf="!isViewOnly">
            <h3 class="section-title">Update status</h3>
            <select [(ngModel)]="newStatus" class="form-input form-select">
              <option value="">Select status</option>
              <option value="New">New</option>
              <option value="Contacted">Contacted</option>
              <option value="Scheduled">Scheduled</option>
              <option value="Closed">Closed</option>
            </select>
            <button (click)="updateLeadStatus()" [disabled]="!newStatus" class="btn btn-primary btn-full">
              Update Status
            </button>
          </div>

          <div class="detail-section" *ngIf="!isViewOnly">
            <div class="section-header">
              <h3 class="section-title">Add note</h3>
              <button
                *ngIf="selectedLead.callHistory && selectedLead.callHistory.length > 0"
                (click)="toggleNotesPanel()"
                class="btn btn-sm btn-outline"
              >
                {{ showNotesPanel ? 'Hide' : 'View' }} Notes ({{ selectedLead.callHistory.length }})
              </button>
            </div>
            <textarea [(ngModel)]="noteText" placeholder="Add a note..." class="form-input textarea" rows="4"></textarea>
            <button (click)="addNoteToLead()" [disabled]="!noteText.trim()" class="btn btn-primary btn-full">
              Add Note
            </button>
          </div>

          <div class="detail-section" *ngIf="!isViewOnly">
            <h3 class="section-title">Schedule follow-up</h3>
            <div class="form-group">
              <label class="form-label">Follow-up date</label>
              <input type="date" [(ngModel)]="followUpDate" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">Follow-up time</label>
              <input type="time" [(ngModel)]="followUpTime" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea [(ngModel)]="followUpNotes" placeholder="Follow-up notes..." class="form-input textarea" rows="3"></textarea>
            </div>
            <button (click)="scheduleFollowUp()" [disabled]="!followUpDate || !followUpTime" class="btn btn-primary btn-full">
              Schedule Follow-Up
            </button>
          </div>

          <div class="detail-section notes-panel" *ngIf="showNotesPanel && selectedLead.callHistory && selectedLead.callHistory.length">
            <h3 class="section-title">Previous notes and history</h3>
            <ul class="history-list">
              <li *ngFor="let call of selectedLead.callHistory" class="history-item">{{ call }}</li>
            </ul>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline" type="button" (click)="closeModal()">Close</button>
        </div>
      </div>
    </div>
  </main>
</div>
